document.addEventListener("DOMContentLoaded",function(){document.getElementById("container").addEventListener("click",function(e){const t=e.target.closest(".card");if(t){const e=t.dataset.id,n=window.nodeData?.find(t=>t.id===e);n&&showInspector(n)}})});let currentInspectedNodeId=null;function showInspector(e){window.currentInspectedNodeId=e.id,document.querySelectorAll(".card.selected").forEach(e=>e.classList.remove("selected")),currentInspectedNodeId=e.id;const t=document.querySelector(`.card[data-id="${e.id}"]`);t&&t.classList.add("selected");let n=JSON.parse(localStorage.getItem("nodes"))||{metadata:{},nodes:window.nodeData};n.metadata.selectedNode=e.id,localStorage.setItem("nodes",JSON.stringify(n)),document.getElementById("inspector-title").innerHTML=`\n        <input id="inspector-label-input" type="text" value="${e.data?.label||e.id}" style="font-size:1.2em; width:90%; padding:4px; border-radius:6px; border:1px solid #888; background:#18192a; color:#fff;">\n    `;const o=window.runtimeState.getNodeState(e.id).cluster,d=window.runtimeState.getNodeState(e.id).sortOrder;document.getElementById("inspector-details").innerHTML=`\n        <p>Cluster: ${o}</p>\n        <p>Sort order: ${d}</p>\n        <p>Node data:</p>\n        <pre>${JSON.stringify(e,null,2)}</pre>\n    `;const s=document.getElementById("inspector-tool-panel");s.innerHTML="",s&&(s.className="",s.classList.add(`node-type-${e.type}`));let c=e.type;function i(){const t=window.inspectorToolPanels[c]||window.inspectorToolPanels[e.type];t&&t(e,s)}if("tool"===e.type&&e.toolType&&(c=`tool:${e.toolType}`),window.inspectorToolPanels[c])i();else if("tool"===e.type&&e.toolType){const t=`inspector-panel-${e.toolType}`;if(document.getElementById(t))setTimeout(i,100);else{const n=document.createElement("script");n.id=t,n.src=`nodeEditor/inspector/inspectorPanelTool_${e.toolType}.js`,n.onload=i,document.body.appendChild(n)}}else if("agent"===e.type){const e="inspector-panel-agent";if(document.getElementById(e))setTimeout(i,100);else{const t=document.createElement("script");t.id=e,t.src="nodeEditor/inspector/inspectorPanelAgent.js",t.onload=i,document.body.appendChild(t)}}else if("broadcaster"===e.type){const e="inspector-panel-broadcaster";if(document.getElementById(e))setTimeout(i,100);else{const t=document.createElement("script");t.id=e,t.src="nodeEditor/inspector/inspectorPanelBroadcaster.js",t.onload=i,document.body.appendChild(t)}}else if("receiver"===e.type){const e="inspector-panel-receiver";if(document.getElementById(e))setTimeout(i,100);else{const t=document.createElement("script");t.id=e,t.src="nodeEditor/inspector/inspectorPanelReceiver.js",t.onload=i,document.body.appendChild(t)}}else if("comment"===e.type){const e="inspector-panel-comment";if(document.getElementById(e))setTimeout(i,100);else{const t=document.createElement("script");t.id=e,t.src="nodeEditor/inspector/inspectorPanelComment.js",t.onload=i,document.body.appendChild(t)}}else i();document.getElementById("inspector-modal").classList.add("active"),document.body.classList.add("inspector-open");const l=document.getElementById("inspector-label-input");l.addEventListener("change",function(){e.data=e.data||{},e.data.label=l.value;const t={metadata:{lastScratchProjectId:window.lastScratchProjectId||null},nodes:window.nodeData};localStorage.setItem("nodes",JSON.stringify(t)),window.loadNodes&&window.loadNodes()})}function updateAgentPanel(){const e=document.getElementById("inspector-tool-panel");if(!e)return;const t=window.currentInspectedNodeId,n=window.nodeData?.find(e=>e.id===t);n&&window.inspectorToolPanels.agent&&window.inspectorToolPanels.agent(n,e)}window.inspectorToolPanels={},window.inspectorToolPanels.tool=function(e,t){t.innerHTML=`<div style="color:#fff;">Custom Tool Panel for ${e.data?.label||e.id}</div>`},document.getElementById("delete-inspector").onclick=function(){if(!currentInspectedNodeId||!window.nodeData)return;window.nodeData=window.nodeData.filter(e=>e.id!==currentInspectedNodeId),window.nodeData.forEach(e=>{e.inputs=(e.inputs||[]).filter(e=>e!==currentInspectedNodeId),e.outputs=(e.outputs||[]).filter(e=>e!==currentInspectedNodeId)});const e={metadata:{lastScratchProjectId:window.lastScratchProjectId||null},nodes:window.nodeData};localStorage.setItem("nodes",JSON.stringify(e)),window.loadNodes&&window.loadNodes(),document.getElementById("inspector-modal").classList.remove("active"),document.body.classList.remove("inspector-open"),document.querySelectorAll(".card.selected").forEach(e=>e.classList.remove("selected")),currentInspectedNodeId=null,clearSelectedNode()},document.getElementById("close-inspector").onclick=function(){document.getElementById("inspector-modal").classList.remove("active"),document.body.classList.remove("inspector-open"),document.querySelectorAll(".card.selected").forEach(e=>e.classList.remove("selected")),currentInspectedNodeId=null,clearSelectedNode()},document.getElementById("run-inspector").onclick=function(){currentInspectedNodeId&&window.nodeData&&window.runNodeCluster(currentInspectedNodeId)},window.showInspector=showInspector,window.updateAgentPanel=updateAgentPanel;const inspectorModal=document.getElementById("inspector-modal");inspectorModal.style.height="45vh";const resizeHandle=document.createElement("div");resizeHandle.id="inspector-resize-handle",inspectorModal.appendChild(resizeHandle);let isResizing=!1,startY=0,startHeight=0;function clearSelectedNode(){let e=JSON.parse(localStorage.getItem("nodes"))||{metadata:{},nodes:window.nodeData};e.metadata.selectedNode=null,localStorage.setItem("nodes",JSON.stringify(e))}resizeHandle.addEventListener("mousedown",function(e){isResizing=!0,startY=e.clientY,startHeight=inspectorModal.offsetHeight,document.body.style.cursor="ns-resize",document.body.style.userSelect="none"}),document.addEventListener("mousemove",function(e){if(!isResizing)return;const t=startY-e.clientY;inspectorModal.style.height=`${startHeight+t}px`}),document.addEventListener("mouseup",function(){isResizing&&(isResizing=!1,document.body.style.cursor="",document.body.style.userSelect="")});